################################################################################
# This file contains the configuration for the cortex-annotate toolkit. By
# editing this file, one can configure cortex-annotate to work with various
# datasets and to enable annotation of specific contours, points, and
# boundaries.

display:
  figsize: [4, 4]
  dpi: 128
  plot_options:
    color: [0.55, 0.55, 0.9]
    markersize: 0
    linewidth: 2
    linestyle: "solid"
  fg_options:
    color: [0.97, 0.97, 0.97]
    markersize: 2
    
init: |
  # Load libraries that will be used throughout the configuration file.
  import re
  import glob
  import numpy as np
  import os.path as op
  import neuropythy as ny
  from struct import unpack
  from matplotlib.colors import LinearSegmentedColormap

  # Define directories
  dataset  = "hcp-retinotopy"
  data_dir = op.join("/home", "jovyan", "datasets", dataset)

  # define flatmap kwargs
  FLATMAP_KWARGS = {
    "mask"      : ( "parcellation", 43 ), 
    "map_right" : "right",
    "radius"    : np.pi / 2
  }

  # load fsaverage as a subject object
  fsa = ny.freesurfer_subject("fsaverage")

  # prepare fsaverage flatmap
  fsa_flatmaps = {} # initialize
  fsa_flatmaps["lh"] = fsa.hemis["lh"].mask_flatmap(**FLATMAP_KWARGS)
  fsa_flatmaps["rh"] = fsa.hemis["rh"].mask_flatmap(**FLATMAP_KWARGS)
  
  # define a custom colormap for edge figures
  edge_cmap = LinearSegmentedColormap.from_list(
    name = "edge", 
    colors = [
      (0, (0, 1, 1)),    # negative values begin at cyan
      (0.48, (0, 0, 0)), # black edge, just before the threshold value
      (0.52, (1, 1, 1)), # white edge, just after the threshold value
      (1, (1, 0, 0))     # positive values go towards red
    ]
  )

  
targets:
  # The "Participant" is a choice for the user. It will appear as a dropdown 
  # menu with these two options in the annotation tool.
  Participant:
    - "100610"
    - "102311"
    - "102816"
    - "104416"
    - "105923"
    - "108323"
    - "109123"
    - "111312"
    - "111514"
    - "114823"
    - "115017"
    - "115825"
    - "116726"
    - "118225"
    - "125525"
    - "126426"
    - "128935"
    - "130114"
    - "130518"
    - "131217"
    - "131722"
    - "132118"
    - "134627"
    - "134829"
    - "135124"
    - "137128"
    - "140117"
    - "144226"
    - "145834"
    - "146129"
    - "146432"
    - "146735"
    - "146937"
    - "148133"
    - "150423"
    - "155938"
    - "156334"
    - "157336"
    - "158035"
    - "158136"
    - "159239"
    - "162935"
    - "164131"
    - "164636"
    - "165436"
    - "167036"
    - "167440"
    - "169040"
    - "169343"
    - "169444"
    - "169747"
    - "171633"
    - "172130"
    - "173334"
    - "175237"
    - "176542"
    - "177140"
    - "177645"
    - "177746"
    - "178142"
    - "178243"
    - "178647"
    - "180533"
    - "181232"
    - "181636"
    - "182436"
    - "182739"
    - "185442"
    - "186949"
    - "187345"
    - "191033"
    - "191336"
    - "191841"
    - "192439"
    - "192641"
    - "193845"
    - "195041"
    - "196144"
    - "197348"
    - "198653"
    - "199655"
    - "200210"
    - "200311"
    - "200614"
    - "201515"
    - "203418"
    - "204521"
    - "205220"
    - "209228"
    - "212419"
    - "214019"
    - "214524"
    - "221319"
    - "233326"
    - "239136"
    - "246133"
    - "249947"
    - "251833"
    - "257845"
    - "263436"
    - "283543"
    - "318637"
    - "320826"
    - "330324"
    - "346137"
    - "352738"
    - "360030"
    - "365343"
    - "380036"
    - "381038"
    - "385046"
    - "389357"
    - "393247"
    - "395756"
    - "397760"
    - "401422"
    - "406836"
    - "412528"
    - "429040"
    - "436845"
    - "463040"
    - "467351"
    - "525541"
    - "536647"
    - "541943"
    - "547046"
    - "550439"
    - "552241"
    - "562345"
    - "572045"
    - "573249"
    - "581450"
    - "585256"
    - "601127"
    - "617748"
    - "627549"
    - "638049"
    - "644246"
    - "654552"
    - "671855"
    - "680957"
    - "690152"
    - "706040"
    - "724446"
    - "725751"
    - "732243"
    - "751550"
    - "757764"
    - "765864"
    - "770352"
    - "771354"
    - "782561"
    - "783462"
    - "789373"
    - "814649"
    - "818859"
    - "825048"
    - "826353"
    - "833249"
    - "859671"
    - "861456"
    - "871762"
    - "872764"
    - "878776"
    - "878877"
    - "898176"
    - "899885"
    - "901139"
    - "901442"
    - "905147"
    - "910241"
    - "926862"
    - "927359"
    - "942658"
    - "943862"
    - "951457"
    - "958976"
    - "966975"
    - "971160"
    - "973770"
    - "995174"

  # The "Hemisphere" is a choice for the user; as a list of two options, it will
  # appear as a dropdown menu with these two options in the annotation tool.
  Hemisphere:
    - Left Hemisphere
    - Right Hemisphere

  # create subject flatmap.
  flatmap: |
    # get dropdown selections from above choices.
    participant = target["Participant"] # int
    hemi        = target["Hemisphere"]  # string

    # format dropdown items
    fs_hemi = f"{hemi[0].lower()}h"

    # define participant directory
    participant_dir = op.join(data_dir, participant)

    # find all participant property files
    prop_files = glob.glob(op.join(participant_dir, f"{fs_hemi}.2d.*"))

    # read in all subject properties
    props = {} # initialize
    for fname in prop_files: # for each property file
      prop_name = fname.split(".")[-1]
      with open(fname, "rb") as f:
        values = f.read() # read property file, float16
        values = unpack("e" * (len(values) // 2), values)
      props[prop_name] = values

    # copy fsaverage flatmap 
    participant_flatmap = fsa_flatmaps[fs_hemi].copy()

    # attatch and return properties to fsaverage flatmap
    return participant_flatmap.with_prop(props)


annotations:
  # V1 contours:
  V1 Foveal Point:
    type: point
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V1 UVM (ventral):
    fixed_head: V1 Foveal Point
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V1 LVM (dorsal):
    fixed_head: V1 Foveal Point
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V1 Periphery:
    fixed_head:
      requires: V1 UVM (ventral)
      calculate: |
        return annotations["V1 UVM (ventral)"][-1,:]
    fixed_tail:
      requires: V1 LVM (dorsal)
      calculate: |
        return annotations["V1 LVM (dorsal)"][-1,:]
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  # V2 contours:
  V2 Foveal Point:
    type: point
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V2 UVM (ventral):
    fixed_head: V2 Foveal Point
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V2 LVM (dorsal):
    fixed_head: V2 Foveal Point
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V2 Ventral Periphery:
    fixed_head:
      requires: V2 UVM (ventral)
      calculate: |
        return annotations["V2 UVM (ventral)"][-1,:]
    fixed_tail:
      requires: V1 UVM (ventral)
      calculate: |
        return annotations["V1 UVM (ventral)"][-1,:]
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V2 Dorsal Periphery:
    fixed_head:
      requires: V2 LVM (dorsal)
      calculate: |
        return annotations["V2 LVM (dorsal)"][-1,:]
    fixed_tail:
      requires: V1 LVM (dorsal)
      calculate: |
        return annotations["V1 LVM (dorsal)"][-1,:]
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  # V3 contours:
  V3 Foveal Point:
    type: point
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V3 UVM (ventral):
    fixed_head: V3 Foveal Point
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V3 LVM (dorsal):
    fixed_head: V3 Foveal Point
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V3 Ventral Periphery:
    fixed_head:
      requires: V3 UVM (ventral)
      calculate: |
        return annotations["V3 UVM (ventral)"][-1,:]
    fixed_tail:
      requires: V2 UVM (ventral)
      calculate: |
        return annotations["V2 UVM (ventral)"][-1,:]
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V3 Dorsal Periphery:
    fixed_head:
      requires: V3 LVM (dorsal)
      calculate: |
        return annotations["V3 LVM (dorsal)"][-1,:]
    fixed_tail:
      requires: V2 LVM (dorsal)
      calculate: |
        return annotations["V2 LVM (dorsal)"][-1,:]
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  # hV4 contour:
  hV4 Outer:
    type: contour
    fixed_head: V3 Foveal Point
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  # VO contour:
  VO Outer:
    type: contour
    fixed_head:
      requires: V3 UVM (ventral)
      calculate: |
        return annotations["V3 UVM (ventral)"][-1,:]
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  # hV4|VO boundary:
  hV4|VO Boundary:
    type: contour
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  # VO1|2 boundary:
  VO1|2 Boundary: 
    type: contour
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  # V3a|b contours:
  V3a|b Outer:
    type: contour
    fixed_head:
      requires: V3 LVM (dorsal)
      calculate: |
        return annotations["V3 LVM (dorsal)"][-1,:]
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  V3a|b Inner Boundary:
    type: contour
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  # IPS0 Outer:
  IPS0 Outer:
    type: contour
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  # LO1 Outer:
  LO1 Outer:
    type: contour
    fixed_head: V3 Foveal Point
    grid:
      - ["angle", "eccen"]
      - ["curvature", "vexpl"]
  # Isoecentricity contours:
  0.5 degrees Eccentricity:
    type: contour
    grid:
      - ["eccen_0.5", "angle"]
      - ["eccen", "vexpl"]
  1.0 degrees Eccentricity:
    type: contour
    grid:
      - ["eccen_1.0", "angle"]
      - ["eccen", "vexpl"]
  2.0 degrees Eccentricity:
    type: contour
    grid:
      - ["eccen_2.0", "angle"]
      - ["eccen", "vexpl"]
  4.0 degrees Eccentricity:
    type: contour
    grid:
      - ["eccen_4.0", "angle"]
      - ["eccen", "vexpl"]
  7.0 degrees Eccentricity:
    type: contour
    grid:
      - ["eccen_7.0", "angle"]
      - ["eccen", "vexpl"]


figures:
  term: |
    # figure aesthetics and limits
    xy = target["flatmap"].coordinates
    (xmin, ymin) = np.min(xy, axis = 1)
    (xmax, ymax) = np.max(xy, axis = 1)
    axes.set_xlim((xmin, xmax))
    axes.set_ylim((ymin, ymax))
  angle: |
    # prepare hemisphere information
    hemi    = target["Hemisphere"]  # string
    fs_hemi = f"{hemi[0].lower()}h"
    
    ny.cortex_plot(target["flatmap"], 
      color = { f"polar_angle_{fs_hemi}": target["flatmap"].properties["angle"] }, 
      axes = axes)
  eccen: |
    ny.cortex_plot(target["flatmap"], 
      color = { "eccentricity": target["flatmap"].properties["eccen"] }, 
      axes = axes)
  vexpl: |
    ny.cortex_plot(target["flatmap"], color = "vexpl", cmap = "hot", 
      vmin = 0, vmax = 100, axes = axes)
  curvature: |
    ny.cortex_plot(target["flatmap"], axes = axes)
  _: |
    # Prepare property name and threshold from figure name
    prop_name, threshold = key.split("_")
    
    # Compute values relative to threshold 
    # (clipped to [0, 16] eccentricity to remove extreme outliers)
    values = np.clip(target["flatmap"].properties[prop_name].copy(), 0, 16)
    values = values - float(threshold) 
  
    # Normalize negative values to [-1, 0]
    negative_index = values < 0
    values[negative_index] = values[negative_index] / np.abs(np.nanmin(values[negative_index]))

    # Normalize positive values to [0, 1]
    positive_index = values > 0
    values[positive_index] = values[positive_index] / np.nanmax(values[positive_index])

    # Plot with diverging colormap, centered at the threshold value
    ny.cortex_plot(target["flatmap"], 
      color = values, cmap = edge_cmap, vmin = -1, vmax = 1, axes = axes)